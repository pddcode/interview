# iOS直播的总结

使用rtmp推流的步骤：
- 1.使用系统接口进行录音，此时录音的格式是pcm
- 2.将pcm进行压缩编码，得到AAC格式
- 3.使用系统接口捕获视频
- 4.对视频文件进行h264编码
- 5.除了AAC和h264以外，还有一种将视频和音频合成在一起的格式，这个格式就是flv格式

## flv格式
flv是一种简单的视频合成格式

常见的视频合成格式：MP4，AVI，rmvb，flv

它支持的指定的音视频格式：h263，h264，AAC，MP3等

flv的组成如下：
```
flv header + script tag + video tag + audio tag + ... + video tag + audio tag
```

flv header内容是固定的

一个tag就像是一个数组中的元素。是一个单独的储存了信息的数据块。

script tag存储了视频相关信息

video tag存储的是完整的视频压缩格式的一帧数据，如h264数据

audio tag中存储的是完整的音频压缩格式的一帧数据，如AAC数据

> rtmp协议所传输的视频流，就要求是flv格式。所以，程序从相机和麦克风捕获到音频数据后，分别转成AAC和h264格式的音视频帧。然后将AAC和h264合成为flv发送到rtmp服务器。

## 缺点
- rtmp为Adobe的私有协议，很多设备无法播放，特别是在iOS端，需要使用第三方解码器才能播放
- 基于TCP协议，非公共端口，可能被防火墙阻拦

# HTTP Live Streaming(HLS)
HLS是Apple实现的基于HTTP的流媒体传输协议，可实现流媒体的直播和点播，主要应用再iOS系统，提供音视频直播和点播方案。

- a.**采集视频源和音频源的数据**
- b.**对原始数据进行h264编码和AAC编码**
- c.**视频和音频数据封装为MPEG-TS包**
- d.**HLS分段生成策略及m3u8索引文件**
- e.**HTTP传输协议**

### HLS的优势
- 客户端支持简单，只需要支持HTTP请求即可，HTTP协议无状态，只需要按顺序下载媒体片即可
- 使用HTTP协议网络兼容性好，HTTP数据包也可以方便地通过防火墙或者代理服务器
- Apple的全系列产品都支持，现在Android也加入了对HLS的支持
- 自带多码率自适应

### HLS的劣势
- 相比RTMP这类长连接协议，延时较高，难以用到互动直播场景
- 文件碎片，ts切片较小，会造成海量小文件，对存储和缓存都有一定挑战

# DASH
基于HTTP的动态自适应流，是一种自适应比特率流技术，使高质量流媒体可以通过传统的HTTP网络服务器以互联网传递。类似苹果公司的HLS方案，DASH会将内容分解成一系列小型的基于HTTP的文件片段，每个片段包括很短长度的可播放内容，而内容总长度可能长达数小时。内容将被制成多种比特率的备选片段，以提供多种比特率的版本供选用。当内容被客户端回放时，客户端将根据当前网络条件自动选择下载和播放哪一个备选方案。客户端将选择可及时下载的最高比特率片段进行播放，从而避免播放卡顿或重新缓冲事件。

> DASH是首个基于HTTP的自适应比特率流解决方案，它是一项国际标准，DASH不应该与传输协议混淆-DASH使用TCP传输协议。

### DASH的优势：
- 1.观看视频更为流畅，我们会在网速不佳时无缝切换至较低清晰度视频，在网速充足时无缝切换至较高清晰度视频，切换过程对用户无感。
  ![](https://i0.hdslb.com/bfs/article/83cc756e270cb9a84ee6df1ce736375a56a414cc.png@1320w_1306h.webp)

- 2.可以很容易的支持音频模式
- 3.在退到后台后，可以自动切换至只拉取音频，更节省流量，播放更加流畅

参考文献：[https://www.bilibili.com/read/cv855111/](https://www.bilibili.com/read/cv855111/)